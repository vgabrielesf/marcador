<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Modelo 3D AR - 1.fbx</title>
    
    <!-- A-Frame -->
    <script src="https://aframe.io/releases/1.4.0/aframe.min.js"></script>
    
    <!-- A-Frame Extras para FBX/GLTF -->
    <script src="https://cdn.jsdelivr.net/gh/donmccurdy/aframe-extras@v6.1.1/dist/aframe-extras.loaders.min.js"></script>
    
    <!-- AR.js -->
    <script src="https://jeromeetienne.github.io/AR.js/aframe/build/aframe-ar.min.js"></script>
    
    <style>
        body { margin: 0; font-family: Arial, sans-serif; background: #000; }
        
        #info {
            position: fixed; top: 10px; left: 10px; right: 10px;
            background: rgba(0, 0, 0, 0.9); color: white;
            padding: 15px; border-radius: 10px; z-index: 9999;
            font-size: 13px; text-align: center; border: 2px solid #00ff88;
        }
        
        #info h3 { margin: 0 0 10px 0; color: #00ff88; }
        .hide { display: none; }
        button { 
            background: #ff4444; color: white; border: none;
            padding: 10px 16px; border-radius: 5px; margin: 5px; cursor: pointer;
            font-size: 12px;
        }
        .success { background: #28a745 !important; }
        .warning { background: #ffc107 !important; color: black !important; }
        .info { background: #17a2b8 !important; }
    </style>
</head>
<body>
    
    <div id="info">
        <h3>üéÆ AR Modelo 1.fbx</h3>
        <p>Verificando arquivo: <strong>1.fbx</strong></p>
        <button class="success" onclick="testCamera()">üìπ Testar C√¢mera</button>
        <button class="warning" onclick="showInstructions()">üìã Instru√ß√µes</button>
        <button class="info" onclick="showMarker()">üéØ Ver Marcador</button>
    </div>

    <!-- Cena AR -->
    <a-scene 
        arjs='sourceType: webcam; trackingMethod: best; sourceWidth:1280; sourceHeight:960; displayWidth: 1280; displayHeight: 960; debugUIEnabled: false;' 
        embedded
        vr-mode-ui="enabled: false"
        loading-screen="enabled: false;">
        
        <!-- Assets -->
        <a-assets timeout="10000">
            <!-- Modelo FBX Principal -->
            <a-asset-item id="fbx-model" src="1.fbx"></a-asset-item>
            
            <!-- Modelos alternativos (caso existam) -->
            <a-asset-item id="gltf-model" src="1.glb"></a-asset-item>
            <a-asset-item id="obj-model" src="1.obj"></a-asset-item>
        </a-assets>
        
        <a-marker preset='hiro' id="hiro-marker">
            
            <!-- Container principal do modelo -->
            <a-entity id="model-container" position="0 0 0">
                
                <!-- Modelo FBX (tentativa principal) -->
                <a-entity 
                    id="fbx-entity"
                    fbx-model="src: #fbx-model"
                    position="0 0 0" 
                    rotation="0 0 0" 
                    scale="1 1 1"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 20000;"
                    visible="true">
                </a-entity>
                
                <!-- Modelo GLTF (backup 1) -->
                <a-entity 
                    id="gltf-entity"
                    gltf-model="src: #gltf-model"
                    position="0 0 0" 
                    rotation="0 0 0" 
                    scale="1 1 1"
                    animation="property: rotation; to: 0 360 0; loop: true; dur: 20000;"
                    visible="false">
                </a-entity>
                
                <!-- Cubo de fallback (backup 2) -->
                <a-box 
                    id="fallback-cube"
                    position="0 0.5 0" 
                    scale="0.8 0.8 0.8" 
                    color="#FF6B6B"
                    material="metalness: 0.3; roughness: 0.4;"
                    animation="property: rotation; to: 360 360 360; loop: true; dur: 8000;"
                    visible="false">
                    
                    <a-text 
                        value="1.fbx\nNAO\nENCONTRADO" 
                        position="0 0 0.51" 
                        align="center" 
                        color="white" 
                        scale="0.4 0.4 0.4">
                    </a-text>
                </a-box>
                
            </a-entity>
            
            <!-- Ilumina√ß√£o otimizada para modelos 3D -->
            <a-light type="ambient" color="#404040" intensity="0.6"></a-light>
            <a-light type="directional" position="2 4 2" color="white" intensity="1"></a-light>
            <a-light type="point" position="-2 2 2" color="#4ECDC4" intensity="0.4"></a-light>
            <a-light type="point" position="2 2 -2" color="#FFB6C1" intensity="0.3"></a-light>
            
        </a-marker>
        
        <a-entity camera></a-entity>
    </a-scene>

    <script>
        let modelLoaded = false;
        let cameraWorking = false;
        let markerFound = false;
        
        function hideInfo() {
            document.getElementById('info').classList.add('hide');
        }
        
        function showMarker() {
            window.open('marcador.html', '_blank');
        }
        
        function showInstructions() {
            document.getElementById('info').innerHTML = `
                <h3>üìã Como usar seu Modelo 1.fbx:</h3>
                <p><strong>1. Verifique o arquivo:</strong></p>
                <ul style="text-align: left; font-size: 11px;">
                    <li>‚úÖ Arquivo "1.fbx" deve estar no reposit√≥rio</li>
                    <li>‚úÖ Nome exato: <strong>1.fbx</strong> (n√£o "modelo.fbx")</li>
                    <li>‚úÖ Tamanho m√°ximo: 20MB</li>
                </ul>
                <p><strong>2. Como usar:</strong></p>
                <ul style="text-align: left; font-size: 11px;">
                    <li>üìπ Teste a c√¢mera primeiro</li>
                    <li>üéØ Use o marcador Hiro</li>
                    <li>üì± Aponte o celular para o marcador</li>
                </ul>
                <button onclick="testCamera()">üìπ Testar</button>
                <button onclick="showMarker()">üéØ Marcador</button>
                <button onclick="hideInfo()">‚ú® AR</button>
            `;
        }
        
        async function testCamera() {
            const infoDiv = document.getElementById('info');
            try {
                infoDiv.innerHTML = '<h3>üîç Testando c√¢mera...</h3><p>Aguarde...</p>';
                
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: { ideal: 'environment' },
                        width: { ideal: 1280 },
                        height: { ideal: 960 }
                    } 
                });
                
                cameraWorking = true;
                stream.getTracks().forEach(track => track.stop());
                
                infoDiv.innerHTML = `
                    <h3>‚úÖ C√¢mera OK!</h3>
                    <p>Agora aponte para o <strong>marcador Hiro</strong></p>
                    <button onclick="showMarker()">üéØ Ver Marcador</button>
                    <button onclick="hideInfo()">‚ñ∂Ô∏è Come√ßar AR</button>
                `;
                
            } catch (error) {
                console.error('Erro c√¢mera:', error);
                infoDiv.innerHTML = `
                    <h3>‚ùå Erro na C√¢mera</h3>
                    <p><strong>Problema:</strong> ${error.message}</p>
                    <p><strong>Solu√ß√µes:</strong></p>
                    <ul style="text-align: left; font-size: 11px;">
                        <li>‚úÖ Clique em "Permitir" quando solicitado</li>
                        <li>‚úÖ Use HTTPS (GitHub Pages funciona)</li>
                        <li>‚úÖ Feche outros apps da c√¢mera</li>
                        <li>‚úÖ Use Chrome ou Firefox</li>
                    </ul>
                    <button onclick="location.reload()">üîÑ Recarregar</button>
                `;
            }
        }
        
        // Gerenciar carregamento dos modelos
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                const fbxEntity = document.querySelector('#fbx-entity');
                const gltfEntity = document.querySelector('#gltf-entity');
                const fallbackCube = document.querySelector('#fallback-cube');
                const marker = document.querySelector('#hiro-marker');
                
                // Detectar marcador
                if (marker) {
                    marker.addEventListener('markerFound', () => {
                        console.log('üéØ Marcador Hiro encontrado!');
                        markerFound = true;
                        if (modelLoaded) {
                            updateStatus('‚úÖ Modelo carregado! Movimente o celular ao redor.');
                        }
                    });
                    
                    marker.addEventListener('markerLost', () => {
                        console.log('‚ùå Marcador perdido');
                        markerFound = false;
                    });
                }
                
                // Tentativa 1: FBX
                if (fbxEntity) {
                    fbxEntity.addEventListener('model-loaded', function() {
                        console.log('‚úÖ Modelo FBX 1.fbx carregado!');
                        modelLoaded = true;
                        updateStatus('‚úÖ Seu modelo 1.fbx foi carregado com sucesso!');
                    });
                    
                    fbxEntity.addEventListener('model-error', function(evt) {
                        console.log('‚ùå Erro no FBX, tentando GLTF...', evt);
                        tryGLTF();
                    });
                }
                
                // Tentativa 2: GLTF
                function tryGLTF() {
                    if (gltfEntity) {
                        gltfEntity.setAttribute('visible', true);
                        fbxEntity.setAttribute('visible', false);
                        
                        gltfEntity.addEventListener('model-loaded', function() {
                            console.log('‚úÖ Modelo GLTF carregado como alternativa!');
                            modelLoaded = true;
                            updateStatus('‚úÖ Modelo 1.glb carregado (alternativa ao FBX)');
                        });
                        
                        gltfEntity.addEventListener('model-error', function() {
                            console.log('‚ùå GLTF tamb√©m falhou, usando fallback...');
                            useFallback();
                        });
                    } else {
                        useFallback();
                    }
                }
                
                // Tentativa 3: Fallback
                function useFallback() {
                    if (fallbackCube) {
                        fallbackCube.setAttribute('visible', true);
                        fbxEntity.setAttribute('visible', false);
                        if (gltfEntity) gltfEntity.setAttribute('visible', false);
                        
                        updateStatus('‚ö†Ô∏è Arquivo 1.fbx n√£o encontrado no reposit√≥rio', true);
                    }
                }
                
                function updateStatus(message, isError = false) {
                    const infoDiv = document.getElementById('info');
                    const bgColor = isError ? 'rgba(220, 53, 69, 0.9)' : 'rgba(40, 167, 69, 0.9)';
                    
                    infoDiv.style.background = bgColor;
                    infoDiv.innerHTML = `
                        <h3>üéÆ ${message}</h3>
                        ${isError ? 
                            '<p><strong>Certifique-se que o arquivo "1.fbx" est√° no reposit√≥rio GitHub</strong></p>' : 
                            '<p>Aponte a c√¢mera para o marcador Hiro</p>'
                        }
                        <button onclick="showInstructions()">üìã Ajuda</button>
                        <button onclick="hideInfo()">OK</button>
                    `;
                }
                
                // Verificar carregamento ap√≥s 8 segundos
                setTimeout(() => {
                    if (!modelLoaded) {
                        console.log('‚ö†Ô∏è Timeout: nenhum modelo carregou, usando fallback...');
                        useFallback();
                    }
                }, 8000);
                
            }, 1000);
        });
        
        // Auto-inicializar teste da c√¢mera
        window.addEventListener('load', () => {
            setTimeout(() => {
                if (!cameraWorking) {
                    testCamera();
                }
            }, 2000);
        });
        
        // For√ßar HTTPS se necess√°rio
        if (location.protocol !== 'https:' && location.hostname !== 'localhost' && location.hostname !== '127.0.0.1') {
            console.warn('‚ö†Ô∏è HTTPS necess√°rio para c√¢mera em dispositivos m√≥veis');
        }
    </script>
</body>
</html>